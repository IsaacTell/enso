name: Engine CI V2

on:
  push:
    branches: ["*"]
  pull_request:
    branches: ["*"]
  workflow_dispatch:

env:
  # Please ensure that this is in sync with graalVersion in build.sbt
  graalVersion: 21.1.0
  # Please ensure that this is in sync with javaVersion in build.sbt
  javaVersion: 11
  # Please ensure that this is in sync with project/build.properties
  sbtVersion: 1.5.2
  # Please ensure that this is in sync with rustVersion in build.sbt
  rustToolchain: nightly-2021-11-29
  # Some moderately recent version of Node.JS is needed to run the library download tests.
  nodeVersion: 14.17.2

jobs:
  test_and_publish:
    name: Engine
    runs-on: ${{ matrix.os }}
    timeout-minutes: 120
    strategy:
      matrix:
        os: [[Windows, self-hosted, engine]]
      fail-fast: false
    steps:
      - uses: actions/checkout@v2
      - run: cargo run --release --bin build-enso -- ${{ github.workspace }}
        working-directory: C:\ci
  try_with_gui:
    name: GUI
    runs-on: ${{ matrix.os }}
    timeout-minutes: 120
    strategy:
      matrix:
        os: [[Windows, self-hosted, gui]]
      fail-fast: false
    steps:
      - uses: actions/checkout@v2
      - run: node run dist --skip-version-validation
